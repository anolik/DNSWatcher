{% extends "base.html" %}
{% from "macros/ui.html" import status_badge %}

{% block title %}{{ domain.hostname }} - Detail{% endblock %}

{% block content %}

{# -- Breadcrumb -- #}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="flex items-center gap-2 text-sm text-light-content-muted dark:text-content-muted">
    <li>
      <a href="{{ url_for('dashboard.index') }}"
         class="hover:text-primary-500 transition-colors">Dashboard</a>
    </li>
    <li class="before:content-['/'] before:mr-2 text-light-content-primary dark:text-content-primary"
        aria-current="page">{{ domain.hostname }}</li>
  </ol>
</nav>

{# -- Page header -- #}
<div class="flex items-center justify-between mb-3">
  <h1 class="text-xl font-semibold text-light-content-primary dark:text-content-primary flex items-center gap-2">
    <i class="bi bi-globe"></i>{{ domain.hostname }}
    {{ status_badge(domain.current_status) }}
  </h1>
  <div class="flex items-center gap-2">
    <form method="post"
          action="{{ url_for('dashboard.check_domain', domain_id=domain.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <button type="submit" class="btn-outline btn-sm">
        <i class="bi bi-arrow-repeat"></i> Check Now
      </button>
    </form>
    <a href="{{ url_for('dashboard.domain_selectors', domain_id=domain.id) }}"
       class="btn-outline btn-sm">
      <i class="bi bi-key"></i> DKIM Selectors
    </a>
  </div>
</div>

{# -- Meta row -- #}
<div class="flex flex-wrap gap-4 mb-4 text-sm text-light-content-muted dark:text-content-muted">
  <span>
    <i class="bi bi-clock mr-1"></i>
    Last checked:
    {% if domain.last_checked_at %}
      {{ domain.last_checked_at|to_tz }} {{ display_tz }}
    {% else %}
      Never
    {% endif %}
  </span>
  {% if domain.last_ok_at %}
  <span>
    <i class="bi bi-check-circle mr-1 text-status-success"></i>
    Last OK: {{ domain.last_ok_at|to_tz }} {{ display_tz }}
  </span>
  {% endif %}
  {% if latest_result %}
  <span>
    <i class="bi bi-stopwatch mr-1"></i>
    Execution: {{ latest_result.execution_time_ms }} ms
  </span>
  {% endif %}
</div>

{% if not latest_result %}
{# -- No results yet -- #}
<div class="rounded-lg border px-4 py-3 text-sm bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-300 border-blue-200 dark:border-blue-800/30">
  <i class="bi bi-info-circle mr-2"></i>
  No checks have been performed for this domain yet. Use the
  <strong>Check Now</strong> button above to run the first check.
</div>

{% else %}
{# -- Results grid -- #}
<div class="grid grid-cols-12 gap-4">

  {# ──────────── SPF Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-shield-shaded mr-1.5"></i>SPF
        </span>
        {{ status_badge(latest_result.spf_status) }}
      </div>
      <div class="p-4">
        {% if latest_result.spf_record %}
          <div class="flex items-start gap-2 mb-2">
            <p class="font-mono text-sm break-all flex-grow text-light-content-primary dark:text-content-primary">
              {{ latest_result.spf_record }}
            </p>
            <button type="button" class="btn-outline btn-sm flex-shrink-0 copy-btn"
                    data-copy-text="{{ latest_result.spf_record }}" title="Copy SPF record">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        {% else %}
          <p class="text-sm text-light-content-muted dark:text-content-muted"><em>No SPF record found.</em></p>
        {% endif %}

        {% if spf_details %}
          <dl class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1 text-sm">
            {% if spf_details.get('policy') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Policy</dt>
            <dd class="text-light-content-primary dark:text-content-primary">
              <code>{{ spf_details.policy }}</code>
            </dd>
            {% endif %}

            {% if spf_details.get('mechanisms') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Mechanisms</dt>
            <dd class="text-light-content-primary dark:text-content-primary">
              {% for mech in spf_details.mechanisms %}
                <span class="badge-secondary mr-1">{{ mech }}</span>
              {% endfor %}
            </dd>
            {% endif %}

            {% if spf_details.get('warnings') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Warnings</dt>
            <dd class="text-light-content-primary dark:text-content-primary">
              {% for warn in spf_details.warnings %}
                <div class="text-status-warning text-sm"><i class="bi bi-exclamation-triangle mr-1"></i>{{ warn }}</div>
              {% endfor %}
            </dd>
            {% endif %}
          </dl>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── DMARC Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-envelope-check mr-1.5"></i>DMARC
        </span>
        {{ status_badge(latest_result.dmarc_status) }}
      </div>
      <div class="p-4">
        {% if latest_result.dmarc_record %}
          <div class="flex items-start gap-2 mb-2">
            <p class="font-mono text-sm break-all flex-grow text-light-content-primary dark:text-content-primary">
              {{ latest_result.dmarc_record }}
            </p>
            <button type="button" class="btn-outline btn-sm flex-shrink-0 copy-btn"
                    data-copy-text="{{ latest_result.dmarc_record }}" title="Copy DMARC record">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
        {% else %}
          <p class="text-sm text-light-content-muted dark:text-content-muted"><em>No DMARC record found.</em></p>
        {% endif %}

        {% if dmarc_details %}
          <dl class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1 text-sm">
            {% for key, label in [
                ('p',     'Policy (p)'),
                ('sp',    'Sub-policy (sp)'),
                ('rua',   'Aggregate reports (rua)'),
                ('ruf',   'Forensic reports (ruf)'),
                ('pct',   'Percentage (pct)'),
                ('aspf',  'SPF alignment (aspf)'),
                ('adkim', 'DKIM alignment (adkim)'),
                ('fo',    'Failure options (fo)'),
            ] %}
              {% if dmarc_details.get(key) %}
              <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">{{ label }}</dt>
              <dd class="text-light-content-primary dark:text-content-primary"><code>{{ dmarc_details[key] }}</code></dd>
              {% endif %}
            {% endfor %}

            {% if dmarc_details.get('warnings') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Warnings</dt>
            <dd class="text-light-content-primary dark:text-content-primary">
              {% for warn in dmarc_details.warnings %}
                <div class="text-status-warning text-sm"><i class="bi bi-exclamation-triangle mr-1"></i>{{ warn }}</div>
              {% endfor %}
            </dd>
            {% endif %}
          </dl>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── DKIM Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-key mr-1.5"></i>DKIM
        </span>
        {{ status_badge(latest_result.dkim_status) }}
      </div>
      <div class="p-0">
        {% if dkim_records %}
          <div class="overflow-x-auto">
            <table class="mica-table">
              <thead>
                <tr>
                  <th>Selector</th>
                  <th class="text-center">Status</th>
                  <th class="text-center">Key Length</th>
                  <th>Algorithm</th>
                </tr>
              </thead>
              <tbody>
                {% for rec in dkim_records %}
                <tr>
                  <td><code>{{ rec.get('selector', '?') }}</code></td>
                  <td class="text-center">
                    {{ status_badge(rec.get('status')) }}
                  </td>
                  <td class="text-center">
                    {% if rec.get('key_size') %}
                      {{ rec.key_size }} bits
                    {% else %}
                      <span class="text-light-content-muted dark:text-content-muted">&mdash;</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if rec.get('key_type') %}
                      <code>{{ rec.key_type|upper }}</code>
                    {% else %}
                      <span class="text-light-content-muted dark:text-content-muted">&mdash;</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="p-4 text-sm text-light-content-muted dark:text-content-muted"><em>No DKIM records found.</em></div>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── Reputation Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-graph-up mr-1.5"></i>Reputation
        </span>
        {{ status_badge(latest_result.reputation_status) }}
      </div>
      <div class="p-4">
        {% if reputation_details %}
          {% if reputation_details.get('listed_on') %}
            <p class="text-sm font-semibold text-status-danger mb-1">
              <i class="bi bi-exclamation-octagon mr-1"></i>Listed on:
            </p>
            <ul class="space-y-1 ml-2 text-sm mb-2">
              {% for bl in reputation_details.listed_on %}
                <li><i class="bi bi-x-circle text-status-danger mr-1"></i>{{ bl }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          {% if reputation_details.get('clean_on') %}
            <p class="text-sm font-semibold text-status-success mb-1">
              <i class="bi bi-check-circle mr-1"></i>Clean on:
            </p>
            <ul class="space-y-1 ml-2 text-sm">
              {% for bl in reputation_details.clean_on %}
                <li><i class="bi bi-check-circle text-status-success mr-1"></i>{{ bl }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          {% if not reputation_details.get('listed_on') and not reputation_details.get('clean_on') %}
            <p class="text-sm text-light-content-muted dark:text-content-muted"><em>No reputation data available.</em></p>
          {% endif %}
        {% else %}
          <p class="text-sm text-light-content-muted dark:text-content-muted"><em>No reputation data available.</em></p>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── MX Records Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-envelope mr-1.5"></i>MX Records
        </span>
        {% if mx_provider %}
          <span class="badge-info">{{ mx_provider }}</span>
        {% endif %}
      </div>
      <div class="p-0">
        {% if mx_records %}
          <div class="overflow-x-auto">
            <table class="mica-table">
              <thead>
                <tr>
                  <th class="text-center">Priority</th>
                  <th>Mail Server</th>
                </tr>
              </thead>
              <tbody>
                {% for rec in mx_records %}
                <tr>
                  <td class="text-center"><code>{{ rec.get('priority', '?') }}</code></td>
                  <td><code>{{ rec.get('exchange', '?') }}</code></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="p-4 text-sm text-light-content-muted dark:text-content-muted"><em>No MX records found.</em></div>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── Geolocation & Law 25 Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-geo-alt mr-1.5"></i>Server Location &amp; Loi 25
        </span>
        {% if law25_status == 'compliant' %}
          <span class="badge-ok">Compliant</span>
        {% elif law25_status == 'review_needed' %}
          <span class="badge-warning">Needs review</span>
        {% elif law25_status == 'unknown' %}
          <span class="badge-pending">Unknown</span>
        {% else %}
          <span class="badge-pending">-</span>
        {% endif %}
      </div>
      <div class="p-0">
        {% if mx_geolocation %}
          <div class="overflow-x-auto">
            <table class="mica-table">
              <thead>
                <tr>
                  <th>Mail Server</th>
                  <th>IP</th>
                  <th class="text-center">Country</th>
                  <th>Network</th>
                </tr>
              </thead>
              <tbody>
                {% for srv in mx_geolocation %}
                <tr>
                  <td class="text-sm"><code>{{ srv.get('exchange', '?') }}</code></td>
                  <td class="text-sm"><code>{{ srv.get('ip', '?') }}</code></td>
                  <td class="text-center">
                    {% if srv.get('country_code') == 'CA' %}
                      <span class="badge-ok">{{ srv.get('country_name', 'Canada') }}</span>
                    {% elif srv.get('country_name') %}
                      <span class="badge-warning">{{ srv.get('country_name') }}</span>
                    {% elif srv.get('country_code') %}
                      <span class="badge-warning">{{ srv.get('country_code') }}</span>
                    {% else %}
                      <span class="badge-pending">?</span>
                    {% endif %}
                  </td>
                  <td class="text-sm text-light-content-muted dark:text-content-muted">{{ (srv.get('description') or '') | truncate(40) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if law25_status == 'review_needed' %}
          <div class="px-4 py-2 bg-amber-50 dark:bg-amber-900/10 border-t border-light-surface-border/20 dark:border-surface-border/10 text-sm">
            <i class="bi bi-exclamation-triangle text-status-warning mr-1"></i>
            <strong>Loi 25:</strong> Mail servers detected outside Canada.
            Verify data processing agreements with your provider.
          </div>
          {% elif law25_status == 'compliant' %}
          <div class="px-4 py-2 bg-green-50 dark:bg-green-900/10 border-t border-light-surface-border/20 dark:border-surface-border/10 text-sm">
            <i class="bi bi-check-circle text-status-success mr-1"></i>
            <strong>Loi 25:</strong> All mail servers are located in Canada.
          </div>
          {% endif %}
        {% else %}
          <div class="p-4 text-sm text-light-content-muted dark:text-content-muted"><em>No geolocation data available.</em></div>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── Registrar Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-building mr-1.5"></i>Domain Registrar
        </span>
      </div>
      <div class="p-4">
        {% if registrar_name %}
          <dl class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1 text-sm">
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Registrar</dt>
            <dd class="text-light-content-primary dark:text-content-primary">{{ registrar_name }}</dd>

            {% if registrar_details.get('creation_date') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Created</dt>
            <dd class="text-light-content-primary dark:text-content-primary">{{ registrar_details.creation_date[:10] }}</dd>
            {% endif %}

            {% if registrar_details.get('expiration_date') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Expires</dt>
            <dd class="text-light-content-primary dark:text-content-primary">{{ registrar_details.expiration_date[:10] }}</dd>
            {% endif %}

            {% if registrar_details.get('name_servers') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Name Servers</dt>
            <dd class="text-light-content-primary dark:text-content-primary">
              {% for ns in registrar_details.name_servers %}
                <div><code>{{ ns }}</code></div>
              {% endfor %}
            </dd>
            {% endif %}
          </dl>
        {% elif registrar_details.get('error') %}
          <p class="text-sm text-light-content-muted dark:text-content-muted"><em>{{ registrar_details.error }}</em></p>
        {% else %}
          <p class="text-sm text-light-content-muted dark:text-content-muted"><em>No registrar data available.</em></p>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── MTA-STS Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-shield-lock mr-1.5"></i>MTA-STS
        </span>
        {{ status_badge(latest_result.mta_sts_status) }}
      </div>
      <div class="p-4">
        {% if latest_result.mta_sts_record %}
          <div class="flex items-start gap-2 mb-3">
            <p class="font-mono text-sm break-all flex-grow text-light-content-primary dark:text-content-primary">
              {{ latest_result.mta_sts_record }}
            </p>
            <button type="button" class="btn-outline btn-sm flex-shrink-0 copy-btn"
                    data-copy-text="{{ latest_result.mta_sts_record }}" title="Copy MTA-STS record">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <dl class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1 text-sm">
            {% if mta_sts_details.get('policy_mode') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Policy Mode</dt>
            <dd>
              {% if mta_sts_details.policy_mode == 'enforce' %}
                <span class="badge-ok">enforce</span>
              {% elif mta_sts_details.policy_mode == 'testing' %}
                <span class="badge-warning">testing</span>
              {% else %}
                <span class="badge-pending">{{ mta_sts_details.policy_mode }}</span>
              {% endif %}
            </dd>
            {% endif %}

            {% if mta_sts_details.get('id') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Policy ID</dt>
            <dd class="text-light-content-primary dark:text-content-primary"><code>{{ mta_sts_details.id }}</code></dd>
            {% endif %}

            {% if mta_sts_details.get('policy_max_age') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Max Age</dt>
            <dd class="text-light-content-primary dark:text-content-primary">{{ mta_sts_details.policy_max_age }}s</dd>
            {% endif %}

            {% if mta_sts_details.get('policy_reachable') is not none %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Policy File</dt>
            <dd>
              {% if mta_sts_details.policy_reachable %}
                <span class="badge-ok">Reachable</span>
              {% else %}
                <span class="badge-warning">Unreachable</span>
              {% endif %}
            </dd>
            {% endif %}

            {% if mta_sts_details.get('tls_rpt_record') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">TLS-RPT</dt>
            <dd class="font-mono text-xs break-all text-light-content-primary dark:text-content-primary">{{ mta_sts_details.tls_rpt_record }}</dd>
            {% endif %}
          </dl>
        {% else %}
          <p class="text-sm text-light-content-muted dark:text-content-muted"><em>No MTA-STS record found.</em></p>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── BIMI Card ──────────── #}
  <div class="col-span-12 lg:col-span-6">
    <div class="mica-card h-full overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-image mr-1.5"></i>BIMI
        </span>
        {{ status_badge(latest_result.bimi_status) }}
      </div>
      <div class="p-4">
        {% if latest_result.bimi_record %}
          <div class="flex items-start gap-2 mb-3">
            <p class="font-mono text-sm break-all flex-grow text-light-content-primary dark:text-content-primary">
              {{ latest_result.bimi_record }}
            </p>
            <button type="button" class="btn-outline btn-sm flex-shrink-0 copy-btn"
                    data-copy-text="{{ latest_result.bimi_record }}" title="Copy BIMI record">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <dl class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1 text-sm">
            {% if bimi_details.get('logo_url') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Logo URL</dt>
            <dd class="text-light-content-primary dark:text-content-primary break-all">
              <code>{{ bimi_details.logo_url | truncate(60) }}</code>
            </dd>
            {% endif %}

            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">VMC (a=)</dt>
            <dd>
              {% if bimi_details.get('has_vmc') %}
                <span class="badge-ok">Yes</span>
              {% else %}
                <span class="badge-pending">No</span>
              {% endif %}
            </dd>

            {% if bimi_details.get('authority_url') %}
            <dt class="font-semibold text-light-content-secondary dark:text-content-secondary">Authority URL</dt>
            <dd class="text-light-content-primary dark:text-content-primary break-all">
              <code>{{ bimi_details.authority_url | truncate(60) }}</code>
            </dd>
            {% endif %}
          </dl>
        {% else %}
          <p class="text-sm text-light-content-muted dark:text-content-muted"><em>No BIMI record found.</em></p>
        {% endif %}
      </div>
    </div>
  </div>

  {# ──────────── DMARC Reports Card ──────────── #}
  {% if dmarc_reports %}
  <div class="col-span-12">
    <div class="mica-card overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-file-earmark-text mr-1.5"></i>DMARC Reports
          <span class="ml-1 text-light-content-muted dark:text-content-muted font-normal">({{ dmarc_reports|length }})</span>
        </span>
        <a href="{{ url_for('dmarc_reports.index', domain=domain.hostname) }}"
           class="text-xs font-medium text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 transition-colors">
          View All <i class="bi bi-chevron-right text-xs"></i>
        </a>
      </div>
      <div class="overflow-x-auto">
        <table class="mica-table">
          <thead>
            <tr>
              <th>Date Range</th>
              <th>Org</th>
              <th class="text-right">Total</th>
              <th class="text-right">Pass</th>
              <th class="text-right">Fail</th>
              <th>Source</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for rpt in dmarc_reports %}
            <tr>
              <td class="whitespace-nowrap text-sm text-light-content-secondary dark:text-content-secondary">
                {{ rpt.begin_date|to_tz("%Y-%m-%d") }}
                <span class="text-light-content-muted dark:text-content-muted mx-1">&rarr;</span>
                {{ rpt.end_date|to_tz("%Y-%m-%d") }}
              </td>
              <td class="font-medium text-light-content-primary dark:text-content-primary">
                {{ rpt.org_name }}
              </td>
              <td class="text-right tabular-nums text-light-content-secondary dark:text-content-secondary">
                {{ rpt.total_messages }}
              </td>
              <td class="text-right">
                {% if rpt.pass_count > 0 %}
                  <span class="badge-ok">{{ rpt.pass_count }}</span>
                {% else %}
                  <span class="text-light-content-muted dark:text-content-muted tabular-nums">0</span>
                {% endif %}
              </td>
              <td class="text-right">
                {% if rpt.fail_count > 0 %}
                  <span class="badge-critical">{{ rpt.fail_count }}</span>
                {% else %}
                  <span class="badge-ok">0</span>
                {% endif %}
              </td>
              <td>
                {% if rpt.source == 'auto' %}
                  <span class="badge-info">Auto</span>
                {% else %}
                  <span class="badge-pending">Manual</span>
                {% endif %}
              </td>
              <td class="text-right">
                <a href="{{ url_for('dmarc_reports.detail', id=rpt.id) }}"
                   class="text-xs font-medium text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 transition-colors">
                  View <i class="bi bi-chevron-right text-xs"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {# ──────────── DNS Errors Card (conditional) ──────────── #}
  {% if dns_errors %}
  <div class="col-span-12">
    <div class="mica-card overflow-hidden border-status-warning">
      <div class="px-4 py-3 bg-amber-100 dark:bg-amber-900/20 text-amber-900 dark:text-amber-200 border-b border-light-surface-border/20 dark:border-surface-border/10">
        <span class="font-semibold text-sm">
          <i class="bi bi-exclamation-triangle mr-1.5"></i>DNS Errors
        </span>
      </div>
      <div class="p-4">
        <ul class="space-y-1 text-sm">
          {% for error in dns_errors %}
            <li>
              <i class="bi bi-bug text-status-warning mr-1"></i>{{ error }}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  {% endif %}

</div>

{# -- History link -- #}
<div class="mt-4 flex items-center gap-2">
  <a href="{{ url_for('history.domain_history', domain_id=domain.id) }}" class="btn-outline btn-sm">
    <i class="bi bi-clock-history"></i> View Check History &amp; Changes
  </a>
  <a href="{{ url_for('history.index') }}" class="btn-outline btn-sm">
    <i class="bi bi-journal-text"></i> All Changes
  </a>
</div>

{% endif %} {# end if latest_result #}

{% endblock %}

{% block extra_js %}
<script>
  document.querySelectorAll(".copy-btn").forEach(function (btn) {
    btn.addEventListener("click", function () {
      var text = btn.getAttribute("data-copy-text");
      navigator.clipboard.writeText(text).then(function () {
        var icon = btn.querySelector("i");
        icon.className = "bi bi-clipboard-check";
        setTimeout(function () { icon.className = "bi bi-clipboard"; }, 1500);
      });
    });
  });
</script>
{% endblock %}
