{% extends "base.html" %}

{% block title %}{{ domain.hostname }} - Detail{% endblock %}

{% block content %}

{# ── Macro: render a status badge ── #}
{% macro status_badge(status) %}
  {% if status == 'ok' %}
    <span class="badge bg-success">OK</span>
  {% elif status == 'warning' %}
    <span class="badge bg-warning text-dark">Warning</span>
  {% elif status == 'critical' %}
    <span class="badge bg-danger">Critical</span>
  {% else %}
    <span class="badge bg-secondary">Pending</span>
  {% endif %}
{% endmacro %}

{# ── Breadcrumb ── #}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{{ url_for('dashboard.index') }}">Dashboard</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">{{ domain.hostname }}</li>
  </ol>
</nav>

{# ── Page header ── #}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 mb-0">
    <i class="bi bi-globe me-2"></i>{{ domain.hostname }}
    {{ status_badge(domain.current_status) }}
  </h1>
  <div class="btn-group btn-group-sm">
    <form method="post"
          action="{{ url_for('dashboard.check_domain', domain_id=domain.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <button type="submit" class="btn btn-outline-primary">
        <i class="bi bi-arrow-repeat me-1"></i>Check Now
      </button>
    </form>
    <a href="{{ url_for('dashboard.domain_selectors', domain_id=domain.id) }}"
       class="btn btn-outline-secondary ms-1">
      <i class="bi bi-key me-1"></i>DKIM Selectors
    </a>
  </div>
</div>

{# ── Meta row ── #}
<div class="row mb-4">
  <div class="col-auto">
    <small class="text-muted">
      <i class="bi bi-clock me-1"></i>
      Last checked:
      {% if domain.last_checked_at %}
        {{ domain.last_checked_at.strftime('%Y-%m-%d %H:%M') }} UTC
      {% else %}
        Never
      {% endif %}
    </small>
  </div>
  {% if domain.last_ok_at %}
  <div class="col-auto">
    <small class="text-muted">
      <i class="bi bi-check-circle me-1 text-success"></i>
      Last OK: {{ domain.last_ok_at.strftime('%Y-%m-%d %H:%M') }} UTC
    </small>
  </div>
  {% endif %}
  {% if latest_result %}
  <div class="col-auto">
    <small class="text-muted">
      <i class="bi bi-stopwatch me-1"></i>
      Execution: {{ latest_result.execution_time_ms }} ms
    </small>
  </div>
  {% endif %}
</div>

{% if not latest_result %}
{# ── No results yet ── #}
<div class="alert alert-info">
  <i class="bi bi-info-circle me-2"></i>
  No checks have been performed for this domain yet. Use the
  <strong>Check Now</strong> button above to run the first check.
</div>

{% else %}
{# ── Results grid ── #}
<div class="row g-3">

  {# SPF Card #}
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-shield-shaded me-1"></i>SPF</span>
        {{ status_badge(latest_result.spf_status) }}
      </div>
      <div class="card-body">
        {% if latest_result.spf_record %}
          <p class="font-monospace small text-break mb-2">
            {{ latest_result.spf_record }}
          </p>
        {% else %}
          <p class="text-muted small"><em>No SPF record found.</em></p>
        {% endif %}

        {% if spf_details %}
          <dl class="row mb-0 small">
            {% if spf_details.get('policy') %}
            <dt class="col-sm-4">Policy</dt>
            <dd class="col-sm-8">
              <code>{{ spf_details.policy }}</code>
            </dd>
            {% endif %}

            {% if spf_details.get('mechanisms') %}
            <dt class="col-sm-4">Mechanisms</dt>
            <dd class="col-sm-8">
              {% for mech in spf_details.mechanisms %}
                <span class="badge bg-light text-dark border me-1">{{ mech }}</span>
              {% endfor %}
            </dd>
            {% endif %}

            {% if spf_details.get('warnings') %}
            <dt class="col-sm-4">Warnings</dt>
            <dd class="col-sm-8">
              {% for warn in spf_details.warnings %}
                <div class="text-warning small"><i class="bi bi-exclamation-triangle me-1"></i>{{ warn }}</div>
              {% endfor %}
            </dd>
            {% endif %}
          </dl>
        {% endif %}
      </div>
    </div>
  </div>

  {# DMARC Card #}
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-envelope-check me-1"></i>DMARC</span>
        {{ status_badge(latest_result.dmarc_status) }}
      </div>
      <div class="card-body">
        {% if latest_result.dmarc_record %}
          <p class="font-monospace small text-break mb-2">
            {{ latest_result.dmarc_record }}
          </p>
        {% else %}
          <p class="text-muted small"><em>No DMARC record found.</em></p>
        {% endif %}

        {% if dmarc_details %}
          <dl class="row mb-0 small">
            {% for key, label in [
                ('p',     'Policy (p)'),
                ('sp',    'Sub-policy (sp)'),
                ('rua',   'Aggregate reports (rua)'),
                ('ruf',   'Forensic reports (ruf)'),
                ('pct',   'Percentage (pct)'),
                ('aspf',  'SPF alignment (aspf)'),
                ('adkim', 'DKIM alignment (adkim)'),
                ('fo',    'Failure options (fo)'),
            ] %}
              {% if dmarc_details.get(key) %}
              <dt class="col-sm-5">{{ label }}</dt>
              <dd class="col-sm-7"><code>{{ dmarc_details[key] }}</code></dd>
              {% endif %}
            {% endfor %}

            {% if dmarc_details.get('warnings') %}
            <dt class="col-sm-5">Warnings</dt>
            <dd class="col-sm-7">
              {% for warn in dmarc_details.warnings %}
                <div class="text-warning small"><i class="bi bi-exclamation-triangle me-1"></i>{{ warn }}</div>
              {% endfor %}
            </dd>
            {% endif %}
          </dl>
        {% endif %}
      </div>
    </div>
  </div>

  {# DKIM Card #}
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-key me-1"></i>DKIM</span>
        {{ status_badge(latest_result.dkim_status) }}
      </div>
      <div class="card-body p-0">
        {% if dkim_records %}
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>Selector</th>
                  <th class="text-center">Status</th>
                  <th class="text-center">Key Length</th>
                  <th>Algorithm</th>
                </tr>
              </thead>
              <tbody>
                {% for rec in dkim_records %}
                <tr>
                  <td><code>{{ rec.get('selector', '?') }}</code></td>
                  <td class="text-center">
                    {{ status_badge(rec.get('status')) }}
                  </td>
                  <td class="text-center">
                    {% if rec.get('key_length') %}
                      {{ rec.key_length }} bits
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if rec.get('algorithm') %}
                      <code>{{ rec.algorithm }}</code>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="p-3 text-muted small"><em>No DKIM records found.</em></div>
        {% endif %}
      </div>
    </div>
  </div>

  {# Reputation Card #}
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-graph-up me-1"></i>Reputation</span>
        {{ status_badge(latest_result.reputation_status) }}
      </div>
      <div class="card-body">
        {% if reputation_details %}
          {% if reputation_details.get('listed_on') %}
            <p class="small fw-semibold text-danger mb-1">
              <i class="bi bi-exclamation-octagon me-1"></i>Listed on:
            </p>
            <ul class="list-unstyled ms-2 small mb-2">
              {% for bl in reputation_details.listed_on %}
                <li><i class="bi bi-x-circle text-danger me-1"></i>{{ bl }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          {% if reputation_details.get('clean_on') %}
            <p class="small fw-semibold text-success mb-1">
              <i class="bi bi-check-circle me-1"></i>Clean on:
            </p>
            <ul class="list-unstyled ms-2 small mb-0">
              {% for bl in reputation_details.clean_on %}
                <li><i class="bi bi-check-circle text-success me-1"></i>{{ bl }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          {% if not reputation_details.get('listed_on') and not reputation_details.get('clean_on') %}
            <p class="text-muted small"><em>No reputation data available.</em></p>
          {% endif %}
        {% else %}
          <p class="text-muted small"><em>No reputation data available.</em></p>
        {% endif %}
      </div>
    </div>
  </div>

  {# DNS Errors Card - only when there are errors #}
  {% if dns_errors %}
  <div class="col-12">
    <div class="card border-warning">
      <div class="card-header bg-warning text-dark">
        <i class="bi bi-exclamation-triangle me-1"></i>DNS Errors
      </div>
      <div class="card-body">
        <ul class="list-unstyled mb-0 small">
          {% for error in dns_errors %}
            <li class="mb-1">
              <i class="bi bi-bug text-warning me-1"></i>{{ error }}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  {% endif %}

</div>

{# ── History link ── #}
<div class="mt-3">
  <a href="{{ url_for('history.domain_history', domain_id=domain.id) }}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-clock-history me-1"></i>View Check History &amp; Changes
  </a>
  <a href="{{ url_for('history.index') }}" class="btn btn-outline-secondary btn-sm ms-1">
    <i class="bi bi-journal-text me-1"></i>All Changes
  </a>
</div>

{% endif %} {# end if latest_result #}

{% endblock %}
