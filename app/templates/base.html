<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}SPF/DMARC/DKIM Watcher{% endblock %}</title>

  {# FOUC prevention: apply dark class before paint #}
  <script>
    (function(){
      var t=localStorage.getItem("mica-theme");
      if(t==="dark"||(t!=="light"&&window.matchMedia("(prefers-color-scheme:dark)").matches)){
        document.documentElement.classList.add("dark");
      }
    })();
  </script>

  {# Compiled Tailwind CSS (MICA design system) #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />

  {# Bootstrap Icons (CSS-only, no JS dependency) #}
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

  <style>
    /* Sortable table headers */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: rgba(0,0,0,.04); }
    .dark th.sortable:hover { background-color: rgba(255,255,255,.06); }
    .sort-icon { font-size: .65em; opacity: .5; margin-left: .25em; }
    th.sortable:hover .sort-icon { opacity: 1; }
    /* Narrow columns */
    .col-narrow    { width: 7rem; max-width: 7rem; white-space: nowrap; }
    .col-narrow-sm { width: 5.5rem; max-width: 5.5rem; white-space: nowrap; }
    /* Per-column filter row */
    .filter-row th { padding: .25rem .35rem; }
    /* Hide caret on kebab action dropdowns */
    .dropdown-toggle::after { display: none; }
    /* Dropdown menu (custom) */
    .dropdown-menu {
      z-index: 50;
      min-width: 12rem;
      border-radius: 0.5rem;
      overflow: hidden;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  {# ── Navigation bar ── #}
  {% if current_user.is_authenticated %}
  <nav class="sticky top-0 z-40 glass-surface border-b border-light-surface-border/20 dark:border-surface-border/10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-14">

        {# Brand #}
        <a href="{{ url_for('dashboard.index') }}"
           class="flex items-center gap-2 font-bold text-light-content-primary dark:text-content-primary tracking-wide text-sm">
          <i class="bi bi-shield-check text-primary-400"></i>
          <span>DNS Watcher</span>
        </a>
        {% if user_is_admin %}
        <a href="{{ url_for('admin.users') }}"
           class="p-2 rounded-lg text-light-content-secondary dark:text-content-secondary hover:bg-gray-100 dark:hover:bg-surface-raised transition-colors"
           title="Administration">
          <i class="bi bi-gear-fill"></i>
        </a>
        {% endif %}

        {# Desktop nav links #}
        <div class="hidden md:flex items-center gap-1">
          {% set nav_items = [
            ('dashboard.index', 'speedometer2', 'Dashboard', 'dashboard.', false),
            ('history.index', 'clock-history', 'Changes', 'history.', false),
            ('ingest.index', 'upload', 'Import', 'ingest.', false),
            ('dmarc_reports.index', 'envelope-open', 'DMARC', 'dmarc_reports.', false),
            ('settings.index', 'gear', 'Settings', 'settings.', false),
            ('history.health_page', 'heart-pulse', 'Health', None, false),
          ] %}
          {% for endpoint_name, icon, label, prefix, admin_only in nav_items %}
            {% if not admin_only or user_is_admin %}
            {% if prefix %}
              {% set is_active = request.endpoint and request.endpoint.startswith(prefix) %}
            {% else %}
              {% set is_active = request.endpoint == endpoint_name %}
            {% endif %}
            <a href="{{ url_for(endpoint_name) }}"
               class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors
                      {% if is_active %}
                        bg-primary-500/10 text-primary-500 dark:text-primary-300
                      {% else %}
                        text-light-content-secondary dark:text-content-secondary
                        hover:bg-gray-100 dark:hover:bg-surface-raised
                      {% endif %}">
              <i class="bi bi-{{ icon }} mr-1"></i>{{ label }}
            </a>
            {% endif %}
          {% endfor %}
        </div>

        {# Right side: theme toggle + user menu #}
        <div class="flex items-center gap-3">
          {# Theme toggle #}
          <button id="theme-toggle" type="button"
                  aria-label="Toggle dark mode"
                  class="p-2 rounded-lg text-light-content-secondary dark:text-content-secondary
                         hover:bg-gray-100 dark:hover:bg-surface-raised transition-colors">
            <svg class="icon-sun w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <svg class="icon-moon w-4 h-4" style="display:none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </button>

          {# Current organization display #}
          {% if current_org %}
          <span class="hidden sm:inline text-xs text-light-content-muted dark:text-content-muted">
            <i class="bi bi-building mr-1"></i>{{ current_org.name }}
          </span>
          {% endif %}

          {# User info + logout #}
          <a href="{{ url_for('auth.profile') }}"
             class="hidden sm:inline text-xs text-light-content-muted dark:text-content-muted hover:text-primary-500 transition-colors">
            <i class="bi bi-person-circle mr-1"></i>{{ current_user.username }}
          </a>
          <a href="{{ url_for('auth.logout') }}"
             class="text-xs text-light-content-muted dark:text-content-muted hover:text-status-danger transition-colors">
            <i class="bi bi-box-arrow-right mr-1"></i>Logout
          </a>

          {# Mobile hamburger #}
          <button id="mobile-nav-toggle" type="button"
                  class="md:hidden p-2 rounded-lg text-light-content-secondary dark:text-content-secondary
                         hover:bg-gray-100 dark:hover:bg-surface-raised transition-colors"
                  aria-label="Toggle navigation" aria-expanded="false">
            <i class="bi bi-list text-lg"></i>
          </button>
        </div>
      </div>

      {# Mobile nav (hidden by default) #}
      <div id="mobile-nav" class="md:hidden hidden pb-3 border-t border-light-surface-border/20 dark:border-surface-border/10 mt-1 pt-2 space-y-1">
        {% for endpoint_name, icon, label, prefix, admin_only in nav_items %}
          {% if not admin_only or user_is_admin %}
          {% if prefix %}
            {% set is_active = request.endpoint and request.endpoint.startswith(prefix) %}
          {% else %}
            {% set is_active = request.endpoint == endpoint_name %}
          {% endif %}
          <a href="{{ url_for(endpoint_name) }}"
             class="block px-3 py-2 rounded-lg text-sm font-medium transition-colors
                    {% if is_active %}
                      bg-primary-500/10 text-primary-500 dark:text-primary-300
                    {% else %}
                      text-light-content-secondary dark:text-content-secondary
                      hover:bg-gray-100 dark:hover:bg-surface-raised
                    {% endif %}">
            <i class="bi bi-{{ icon }} mr-2"></i>{{ label }}
          </a>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </nav>
  {% endif %}

  {# ── Flash messages ── #}
  {% from "macros/ui.html" import flash_messages %}
  {{ flash_messages() }}

  {# ── Main content ── #}
  <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
    {% block content %}{% endblock %}
  </main>

  {# ── Footer ── #}
  <footer class="border-t border-light-surface-border/20 dark:border-surface-border/10 py-3 text-center text-xs text-light-content-muted dark:text-content-muted">
    SPF/DMARC/DKIM Watcher &mdash; monitoring email DNS configurations
  </footer>

  {# ── Scripts ── #}
  {# Chart.js CDN (used by history pages) #}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  {# MICA utilities #}
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
  <script src="{{ url_for('static', filename='js/dropdown.js') }}"></script>
  <script src="{{ url_for('static', filename='js/modal.js') }}"></script>

  {# Mobile nav toggle #}
  <script>
    (function(){
      var btn = document.getElementById("mobile-nav-toggle");
      var nav = document.getElementById("mobile-nav");
      if(btn && nav){
        btn.addEventListener("click", function(){
          nav.classList.toggle("hidden");
          btn.setAttribute("aria-expanded", !nav.classList.contains("hidden"));
        });
      }
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
