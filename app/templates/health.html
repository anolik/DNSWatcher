{% extends "base.html" %}
{% from "macros/ui.html" import status_badge %}
{% block title %}System Health -- DNS Watcher{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h2 class="text-xl font-bold text-light-content-primary dark:text-content-primary">
    <i class="bi bi-heart-pulse mr-2"></i>System Health
  </h2>
  <span class="text-xs text-light-content-muted dark:text-content-muted">
    <i class="bi bi-clock mr-1"></i>Page loaded at {{ now().strftime('%Y-%m-%d %H:%M:%S') }} {{ display_tz }}
  </span>
</div>

{# Summary cards #}
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
  <div class="mica-card">
    <div class="p-4 text-center">
      <i class="bi bi-globe text-2xl text-primary-500"></i>
      <div class="text-3xl font-bold mt-1 text-light-content-primary dark:text-content-primary">{{ total_domains }}</div>
      <div class="text-xs text-light-content-muted dark:text-content-muted">Domains Monitored</div>
    </div>
  </div>
  <div class="mica-card">
    <div class="p-4 text-center">
      <i class="bi bi-check2-circle text-2xl text-status-success"></i>
      <div class="text-3xl font-bold mt-1 text-light-content-primary dark:text-content-primary">{{ checked_today }}</div>
      <div class="text-xs text-light-content-muted dark:text-content-muted">Checked Today</div>
    </div>
  </div>
  <div class="mica-card">
    <div class="p-4 text-center">
      <i class="bi bi-exclamation-triangle text-2xl text-status-danger"></i>
      <div class="text-3xl font-bold mt-1 text-light-content-primary dark:text-content-primary">{{ errors_today }}</div>
      <div class="text-xs text-light-content-muted dark:text-content-muted">DNS Errors Today</div>
    </div>
  </div>
  <div class="mica-card">
    <div class="p-4 text-center">
      <i class="bi bi-database text-2xl text-light-content-secondary dark:text-content-secondary"></i>
      <div class="text-3xl font-bold mt-1 text-light-content-primary dark:text-content-primary">
        {% if db_size is not none %}
          {% if db_size > 1048576 %}
            {{ "%.1f"|format(db_size / 1048576) }} MB
          {% elif db_size > 1024 %}
            {{ "%.1f"|format(db_size / 1024) }} KB
          {% else %}
            {{ db_size }} B
          {% endif %}
        {% else %}
          N/A
        {% endif %}
      </div>
      <div class="text-xs text-light-content-muted dark:text-content-muted">Database Size</div>
    </div>
  </div>
</div>

{# Scheduler info + DNS resolvers #}
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
  {# Last scheduled run #}
  <div class="mica-card overflow-hidden h-full">
    <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10">
      <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
        <i class="bi bi-calendar-check mr-1.5"></i>Last Scheduled Run
      </span>
    </div>
    <div class="p-4">
      {% if last_run_at %}
        <dl class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 text-sm">
          <dt class="font-semibold text-light-content-primary dark:text-content-primary">Timestamp</dt>
          <dd class="text-light-content-secondary dark:text-content-secondary">{{ last_run_at|to_tz('%Y-%m-%d %H:%M:%S') }} {{ display_tz }}</dd>
          <dt class="font-semibold text-light-content-primary dark:text-content-primary">Duration</dt>
          <dd class="text-light-content-secondary dark:text-content-secondary">
            {% if last_run_duration %}
              {% if last_run_duration > 1000 %}
                {{ "%.1f"|format(last_run_duration / 1000) }}s
              {% else %}
                {{ last_run_duration }}ms
              {% endif %}
            {% else %}
              N/A
            {% endif %}
          </dd>
        </dl>
      {% else %}
        <p class="text-sm text-light-content-muted dark:text-content-muted">No scheduled runs recorded yet.</p>
      {% endif %}
    </div>
  </div>

  {# DNS Resolvers #}
  <div class="mica-card overflow-hidden h-full">
    <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
      <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
        <i class="bi bi-hdd-network mr-1.5"></i>DNS Resolvers
      </span>
      {% if dns_settings %}
        <span class="text-xs text-light-content-muted dark:text-content-muted">
          timeout={{ dns_settings.timeout_seconds }}s,
          retries={{ dns_settings.retries }},
          flap_threshold={{ dns_settings.flap_threshold }}
        </span>
      {% endif %}
    </div>
    <div class="overflow-x-auto">
      <table class="mica-table">
        <thead>
          <tr>
            <th>Resolver</th>
            <th class="text-center">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for rs in resolver_statuses %}
          <tr>
            <td><code class="text-xs bg-gray-100 dark:bg-surface-raised px-1.5 py-0.5 rounded">{{ rs.resolver }}</code></td>
            <td class="text-center">
              {% if rs.reachable %}
                <span class="badge-ok"><i class="bi bi-check-lg mr-0.5"></i>Reachable</span>
              {% else %}
                <span class="badge-critical"><i class="bi bi-x-lg mr-0.5"></i>Unreachable</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# Recent check events log #}
<div class="mica-card overflow-hidden">
  <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10 flex items-center justify-between">
    <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
      <i class="bi bi-journal-text mr-1.5"></i>Recent Check Events
    </span>
    <span class="badge-secondary">Last 50</span>
  </div>
  <div class="overflow-x-auto">
    <table class="mica-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Domain</th>
          <th>Trigger</th>
          <th>Overall</th>
          <th>SPF</th>
          <th>DMARC</th>
          <th>DKIM</th>
          <th>Reputation</th>
          <th class="text-right">Duration</th>
        </tr>
      </thead>
      <tbody>
        {% if recent_checks %}
          {% for r in recent_checks %}
          <tr>
            <td class="text-xs text-light-content-muted dark:text-content-muted whitespace-nowrap">{{ r.checked_at|to_tz('%Y-%m-%d %H:%M:%S') }}</td>
            <td>
              {% if r.domain %}
                <a href="{{ url_for('dashboard.domain_detail', domain_id=r.domain_id) }}"
                   class="text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 no-underline">
                  {{ r.domain.hostname }}
                </a>
              {% else %}
                <span class="text-light-content-muted dark:text-content-muted">---</span>
              {% endif %}
            </td>
            <td>
              {% if r.trigger_type == 'scheduled' %}
                <span class="badge-secondary">Scheduled</span>
              {% else %}
                <span class="badge-info">Manual</span>
              {% endif %}
            </td>
            <td>
              {{ status_badge(r.overall_status) }}
            </td>
            {% for status in [r.spf_status, r.dmarc_status, r.dkim_status, r.reputation_status] %}
            <td class="text-center">
              {% if status == 'ok' %}
                <span class="text-status-success"><i class="bi bi-check-circle-fill"></i></span>
              {% elif status == 'warning' %}
                <span class="text-status-warning"><i class="bi bi-exclamation-triangle-fill"></i></span>
              {% elif status == 'critical' or status == 'error' %}
                <span class="text-status-danger"><i class="bi bi-x-circle-fill"></i></span>
              {% elif status %}
                <span class="text-light-content-muted dark:text-content-muted"><i class="bi bi-dash-circle"></i></span>
              {% else %}
                <span class="text-light-content-muted dark:text-content-muted">-</span>
              {% endif %}
            </td>
            {% endfor %}
            <td class="text-right text-xs text-light-content-muted dark:text-content-muted">
              {% if r.execution_time_ms %}
                {% if r.execution_time_ms > 1000 %}
                  {{ "%.1f"|format(r.execution_time_ms / 1000) }}s
                {% else %}
                  {{ r.execution_time_ms }}ms
                {% endif %}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="9" class="text-center text-light-content-muted dark:text-content-muted py-8">No check events recorded yet.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
