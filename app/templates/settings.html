{% extends "base.html" %}

{#
  Determine which tab to open initially (must be at template level, not inside a block,
  so the variable is accessible in both {% block content %} and {% block extra_js %}).
  - If any outbound field has an error, open the Outbound tab.
  - If any graph (inbound) field has an error, open the Inbound tab.
  - Otherwise default to DNS tab (sessionStorage overrides in JS).
#}
{% set _graph_errors = form.graph_tenant_id.errors or form.graph_client_id.errors
                       or form.graph_client_secret.errors or form.graph_mailbox.errors %}
{% set _outbound_errors = form.outbound_tenant_id.errors or form.outbound_client_id.errors
                          or form.outbound_client_secret.errors or form.outbound_mailbox.errors %}
{% set _initial_tab = 'outbound' if _outbound_errors else ('inbound' if _graph_errors else 'dns') %}
{# Feature toggle definitions for the template #}
{% set _core_checks = [
    ('check_spf_enabled',  'bi-shield-shaded',  'SPF',                     'Sender Policy Framework record validation'),
    ('check_dmarc_enabled','bi-envelope-check',  'DMARC',                   'Domain-based Message Authentication, Reporting & Conformance'),
    ('check_dkim_enabled', 'bi-key',             'DKIM',                    'DomainKeys Identified Mail signature verification'),
    ('check_mx_enabled',   'bi-envelope',        'MX Records',              'Mail exchanger record lookup and provider detection'),
] %}
{% set _extra_checks = [
    ('check_reputation_enabled',  'bi-graph-up',      'Reputation (DNSBL)',     'Domain blocklist / spam reputation check'),
    ('check_registrar_enabled',   'bi-building',      'Registrar (WHOIS)',      'Domain registrar, creation and expiry dates'),
    ('check_geolocation_enabled', 'bi-geo-alt',       'Geolocation & Loi 25',  'Mail server physical location and Quebec Law 25 compliance'),
    ('check_mta_sts_enabled',     'bi-shield-lock',   'MTA-STS & TLS-RPT',     'MTA Strict Transport Security and TLS failure reporting'),
    ('check_bimi_enabled',        'bi-image',         'BIMI',                   'Brand Indicators for Message Identification'),
    ('check_tls_enabled',         'bi-lock',          'SMTP TLS (STARTTLS)',    'TLS encryption support on MX mail servers'),
] %}

{% block title %}Settings - SPF/DMARC/DKIM Watcher{% endblock %}

{% block content %}

<h1 class="text-xl font-bold text-light-content-primary dark:text-content-primary mb-4">
  <i class="bi bi-gear mr-2"></i>Settings
</h1>

<div class="grid grid-cols-12 gap-6">

  {# -- Left column: tab bar + form -- #}
  <div class="col-span-12 lg:col-span-7">
    <div class="mica-card overflow-hidden">

      {# -- Tab bar -- #}
      <div class="flex border-b border-light-surface-border/20 dark:border-surface-border/10 px-1 pt-1 gap-1">
        <button type="button"
                id="tab-btn-dns"
                data-tab="dns"
                class="settings-tab-btn px-4 py-2.5 text-sm font-medium rounded-t-lg border-b-2 transition-colors focus:outline-none">
          <i class="bi bi-hdd-network mr-1.5"></i>DNS &amp; Monitoring
        </button>
        <button type="button"
                id="tab-btn-features"
                data-tab="features"
                class="settings-tab-btn px-4 py-2.5 text-sm font-medium rounded-t-lg border-b-2 transition-colors focus:outline-none">
          <i class="bi bi-toggles mr-1.5"></i>Features
        </button>
        <button type="button"
                id="tab-btn-inbound"
                data-tab="inbound"
                class="settings-tab-btn px-4 py-2.5 text-sm font-medium rounded-t-lg border-b-2 transition-colors focus:outline-none">
          <i class="bi bi-envelope-at mr-1.5"></i>Inbound Email
        </button>
        <button type="button"
                id="tab-btn-outbound"
                data-tab="outbound"
                class="settings-tab-btn px-4 py-2.5 text-sm font-medium rounded-t-lg border-b-2 transition-colors focus:outline-none">
          <i class="bi bi-send mr-1.5"></i>Outbound Email
        </button>
      </div>

      {# -- Single form (both panels share it) -- #}
      <form method="post" action="{{ url_for('settings.index') }}">
        {{ form.hidden_tag() }}

        {# ══════════════════════════════════════════════════════════════
           Panel: DNS & Monitoring
           ══════════════════════════════════════════════════════════════ #}
        <div id="panel-dns" data-panel="dns" class="settings-tab-panel p-4">

          {# Resolvers #}
          <div class="mb-4">
            <label for="{{ form.resolvers.id }}"
                   class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
              {{ form.resolvers.label.text }}
            </label>
            {{ form.resolvers(id=form.resolvers.id,
                              class='mica-input font-mono' + (' is-invalid' if form.resolvers.errors else '')) }}
            <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
              Enter one IPv4 address per line. These resolvers are used for all DNS lookups.
            </p>
            {% for err in form.resolvers.errors %}
              <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
            {% endfor %}
          </div>

          {# Timeout / Retries / Flap threshold row #}
          <div class="grid grid-cols-12 gap-3 mb-4">
            <div class="col-span-12 sm:col-span-4">
              <label for="{{ form.timeout_seconds.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.timeout_seconds.label.text }}
              </label>
              {{ form.timeout_seconds(id=form.timeout_seconds.id,
                                      class='mica-input' + (' is-invalid' if form.timeout_seconds.errors else ''),
                                      min=1, max=30) }}
              {% for err in form.timeout_seconds.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            <div class="col-span-12 sm:col-span-4">
              <label for="{{ form.retries.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.retries.label.text }}
              </label>
              {{ form.retries(id=form.retries.id,
                              class='mica-input' + (' is-invalid' if form.retries.errors else ''),
                              min=1, max=10) }}
              {% for err in form.retries.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            <div class="col-span-12 sm:col-span-4">
              <label for="{{ form.flap_threshold.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.flap_threshold.label.text }}
              </label>
              {{ form.flap_threshold(id=form.flap_threshold.id,
                                     class='mica-input' + (' is-invalid' if form.flap_threshold.errors else ''),
                                     min=1, max=5) }}
              <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                Consecutive failures before raising a critical alert.
              </p>
              {% for err in form.flap_threshold.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>
          </div>

          <hr class="border-light-surface-border/20 dark:border-surface-border/10 my-4">

          {# Timezone / Concurrency row #}
          <div class="grid grid-cols-12 gap-3 mb-4">
            <div class="col-span-12 sm:col-span-8">
              <label for="{{ form.display_timezone.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.display_timezone.label.text }}
              </label>
              {{ form.display_timezone(id=form.display_timezone.id,
                                       class='mica-select' + (' is-invalid' if form.display_timezone.errors else '')) }}
              <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                All dates and times in the interface will be displayed in this timezone.
              </p>
              {% for err in form.display_timezone.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            <div class="col-span-12 sm:col-span-4">
              <label for="{{ form.check_concurrency.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.check_concurrency.label.text }}
              </label>
              {{ form.check_concurrency(id=form.check_concurrency.id,
                                        class='mica-input' + (' is-invalid' if form.check_concurrency.errors else ''),
                                        min=1, max=10) }}
              <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                Domains checked in parallel during "Check All".
              </p>
              {% for err in form.check_concurrency.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>
          </div>

          <hr class="border-light-surface-border/20 dark:border-surface-border/10 my-4">

          {# Managed Domains #}
          <div class="mb-4">
            <label for="{{ form.managed_domains.id }}"
                   class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
              <i class="bi bi-check2-circle mr-1.5 text-status-ok"></i>{{ form.managed_domains.label.text }}
            </label>
            {{ form.managed_domains(id=form.managed_domains.id,
                                    class='mica-input font-mono' + (' is-invalid' if form.managed_domains.errors else '')) }}
            <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
              Paste all hostnames managed by your organization. The dashboard will tag
              each domain <span class="badge-ok">YES</span> or <span class="badge-pending">NO</span> accordingly.
            </p>
            {% for err in form.managed_domains.errors %}
              <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
            {% endfor %}
          </div>

          <hr class="border-light-surface-border/20 dark:border-surface-border/10 my-4">

          {# RDAP Servers #}
          <div class="mb-4">
            <label for="{{ form.rdap_servers.id }}"
                   class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
              <i class="bi bi-globe mr-1.5 text-primary-400"></i>{{ form.rdap_servers.label.text }}
            </label>
            {{ form.rdap_servers(id=form.rdap_servers.id,
                                 class='mica-input font-mono' + (' is-invalid' if form.rdap_servers.errors else '')) }}
            <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
              RDAP servers used for registrar lookups (RFC 9083). Multiple servers are
              rotated round-robin to distribute load and avoid rate limits. Default:
              <code class="font-mono text-xs bg-gray-100 dark:bg-surface-raised px-1 py-0.5 rounded">https://rdap.org</code>.
            </p>
            {% for err in form.rdap_servers.errors %}
              <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
            {% endfor %}
          </div>

          <div class="flex items-center gap-4">
            {{ form.submit(class="btn-primary") }}
            <a href="{{ url_for('ingest.index') }}"
               class="text-sm text-light-content-secondary dark:text-content-secondary hover:text-primary-500 transition-colors">
              <i class="bi bi-upload mr-1"></i>Import domains from file
            </a>
          </div>
        </div>{# /panel-dns #}

        {# ══════════════════════════════════════════════════════════════
           Panel: Feature Toggles
           ══════════════════════════════════════════════════════════════ #}
        <div id="panel-features" data-panel="features" class="settings-tab-panel p-4 hidden">

          <p class="text-sm text-light-content-muted dark:text-content-muted mb-5">
            Enable or disable individual checks. Disabled checks are skipped during
            domain validation, saving time and reducing external API calls.
          </p>

          {# ---- Core checks ---- #}
          <h3 class="text-xs font-bold uppercase tracking-wider text-light-content-muted dark:text-content-muted mb-3">
            Core checks
          </h3>
          <div class="space-y-2 mb-5">
            {% for field_name, icon, label, desc in _core_checks %}
              {% set field = form[field_name] %}
              <div class="flex items-start gap-3 p-3 rounded-lg bg-gray-50 dark:bg-surface-raised border border-light-surface-border/20 dark:border-surface-border/10">
                {{ field(id=field.id, class="w-4 h-4 accent-primary-500 flex-shrink-0 mt-0.5") }}
                <label for="{{ field.id }}" class="cursor-pointer select-none flex-grow">
                  <span class="text-sm font-semibold text-light-content-primary dark:text-content-primary">
                    <i class="bi {{ icon }} mr-1.5"></i>{{ label }}
                  </span>
                  <p class="text-xs text-light-content-muted dark:text-content-muted mt-0.5">{{ desc }}</p>
                </label>
              </div>
            {% endfor %}
          </div>

          {# ---- Informational / extended checks ---- #}
          <h3 class="text-xs font-bold uppercase tracking-wider text-light-content-muted dark:text-content-muted mb-3">
            Extended checks
          </h3>
          <div class="space-y-2 mb-5">
            {% for field_name, icon, label, desc in _extra_checks %}
              {% set field = form[field_name] %}
              <div class="flex items-start gap-3 p-3 rounded-lg bg-gray-50 dark:bg-surface-raised border border-light-surface-border/20 dark:border-surface-border/10">
                {{ field(id=field.id, class="w-4 h-4 accent-primary-500 flex-shrink-0 mt-0.5") }}
                <label for="{{ field.id }}" class="cursor-pointer select-none flex-grow">
                  <span class="text-sm font-semibold text-light-content-primary dark:text-content-primary">
                    <i class="bi {{ icon }} mr-1.5"></i>{{ label }}
                  </span>
                  <p class="text-xs text-light-content-muted dark:text-content-muted mt-0.5">{{ desc }}</p>
                </label>
              </div>
            {% endfor %}
          </div>

          <div>
            {{ form.submit(class="btn-primary") }}
          </div>
        </div>{# /panel-features #}

        {# ══════════════════════════════════════════════════════════════
           Panel: Inbound Email (Microsoft Graph API - Mail.Read)
           ══════════════════════════════════════════════════════════════ #}
        <div id="panel-inbound" data-panel="inbound" class="settings-tab-panel p-4 hidden">

          <p class="text-sm text-light-content-muted dark:text-content-muted mb-5">
            Automatically fetch DMARC aggregate reports from an Exchange Online mailbox
            via Microsoft Graph API (OAuth2 client credentials). Requires an
            <strong class="text-light-content-primary dark:text-content-primary">Azure AD App Registration</strong>
            with the <code class="font-mono text-xs bg-gray-100 dark:bg-surface-raised px-1 py-0.5 rounded">Mail.Read</code>
            application permission.
          </p>

          {# Enable toggle #}
          <div class="mb-5 flex items-center gap-3 p-3 rounded-lg bg-gray-50 dark:bg-surface-raised border border-light-surface-border/20 dark:border-surface-border/10">
            {{ form.graph_enabled(id=form.graph_enabled.id, class="w-4 h-4 accent-primary-500 flex-shrink-0") }}
            <label for="{{ form.graph_enabled.id }}"
                   class="text-sm font-semibold text-light-content-primary dark:text-content-primary cursor-pointer select-none">
              {{ form.graph_enabled.label.text }}
            </label>
          </div>

          <div class="grid grid-cols-12 gap-4">

            {# Tenant ID #}
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.graph_tenant_id.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.graph_tenant_id.label.text }}
              </label>
              {{ form.graph_tenant_id(id=form.graph_tenant_id.id,
                                      class="mica-input font-mono text-xs" + (" is-invalid" if form.graph_tenant_id.errors else ""),
                                      placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx") }}
              {% for err in form.graph_tenant_id.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            {# Client ID #}
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.graph_client_id.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.graph_client_id.label.text }}
              </label>
              {{ form.graph_client_id(id=form.graph_client_id.id,
                                      class="mica-input font-mono text-xs" + (" is-invalid" if form.graph_client_id.errors else ""),
                                      placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx") }}
              {% for err in form.graph_client_id.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            {# Client Secret #}
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.graph_client_secret.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.graph_client_secret.label.text }}
              </label>
              {{ form.graph_client_secret(id=form.graph_client_secret.id,
                                           class="mica-input" + (" is-invalid" if form.graph_client_secret.errors else ""),
                                           placeholder="Leave blank to keep current secret") }}
              <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                Leave blank to keep the existing secret unchanged.
              </p>
              {% for err in form.graph_client_secret.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            {# Mailbox #}
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.graph_mailbox.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.graph_mailbox.label.text }}
              </label>
              {{ form.graph_mailbox(id=form.graph_mailbox.id,
                                    class="mica-input" + (" is-invalid" if form.graph_mailbox.errors else ""),
                                    placeholder="dmarc-reports@yourdomain.com") }}
              <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                The Exchange Online mailbox configured as the DMARC <code class="font-mono text-xs">rua=</code> destination.
              </p>
              {% for err in form.graph_mailbox.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>
          </div>

          <hr class="border-light-surface-border/20 dark:border-surface-border/10 my-5">

          {# -- Data Retention -- #}
          <h3 class="text-xs font-bold uppercase tracking-wider text-light-content-muted dark:text-content-muted mb-3">
            <i class="bi bi-clock-history mr-1.5"></i>Data Retention
          </h3>

          <div class="grid grid-cols-12 gap-4 mb-4">
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.data_retention_days.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.data_retention_days.label.text }}
              </label>
              {{ form.data_retention_days(id=form.data_retention_days.id,
                                          class='mica-input' + (' is-invalid' if form.data_retention_days.errors else ''),
                                          min=7, max=730) }}
              <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                DMARC reports, check results, and change logs older than this will be purged.
              </p>
              {% for err in form.data_retention_days.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            <div class="col-span-12 sm:col-span-6 flex items-end">
              <div>
                <p class="text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                  Manual purge
                </p>
                <button type="button" id="btn-purge"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium
                               text-white bg-status-danger hover:bg-red-600
                               rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-400">
                  <i class="bi bi-trash3"></i>Purge old data now
                </button>
                <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                  Immediately deletes data beyond the retention period.
                </p>
              </div>
            </div>
          </div>

          <div class="mt-5">
            {{ form.submit(class="btn-primary") }}
            <a href="{{ url_for('dmarc_reports.index') }}"
               class="ml-3 text-sm text-light-content-secondary dark:text-content-secondary hover:text-primary-500 transition-colors">
              <i class="bi bi-file-earmark-text mr-1"></i>View DMARC Reports
            </a>
          </div>
        </div>{# /panel-inbound #}

        {# ══════════════════════════════════════════════════════════════
           Panel: Outbound Email (Microsoft Graph API - Mail.Send)
           ══════════════════════════════════════════════════════════════ #}
        <div id="panel-outbound" data-panel="outbound" class="settings-tab-panel p-4 hidden">

          <p class="text-sm text-light-content-muted dark:text-content-muted mb-5">
            Send outbound emails (password resets, notifications) via Microsoft Graph API.
            Requires an
            <strong class="text-light-content-primary dark:text-content-primary">Azure AD App Registration</strong>
            with the <code class="font-mono text-xs bg-gray-100 dark:bg-surface-raised px-1 py-0.5 rounded">Mail.Send</code>
            application permission.
          </p>

          {# Enable toggle #}
          <div class="mb-5 flex items-center gap-3 p-3 rounded-lg bg-gray-50 dark:bg-surface-raised border border-light-surface-border/20 dark:border-surface-border/10">
            {{ form.outbound_enabled(id=form.outbound_enabled.id, class="w-4 h-4 accent-primary-500 flex-shrink-0") }}
            <label for="{{ form.outbound_enabled.id }}"
                   class="text-sm font-semibold text-light-content-primary dark:text-content-primary cursor-pointer select-none">
              {{ form.outbound_enabled.label.text }}
            </label>
          </div>

          <div class="grid grid-cols-12 gap-4">

            {# Tenant ID #}
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.outbound_tenant_id.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.outbound_tenant_id.label.text }}
              </label>
              {{ form.outbound_tenant_id(id=form.outbound_tenant_id.id,
                                          class="mica-input font-mono text-xs" + (" is-invalid" if form.outbound_tenant_id.errors else ""),
                                          placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx") }}
              {% for err in form.outbound_tenant_id.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            {# Client ID #}
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.outbound_client_id.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.outbound_client_id.label.text }}
              </label>
              {{ form.outbound_client_id(id=form.outbound_client_id.id,
                                          class="mica-input font-mono text-xs" + (" is-invalid" if form.outbound_client_id.errors else ""),
                                          placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx") }}
              {% for err in form.outbound_client_id.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            {# Client Secret #}
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.outbound_client_secret.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.outbound_client_secret.label.text }}
              </label>
              {{ form.outbound_client_secret(id=form.outbound_client_secret.id,
                                              class="mica-input" + (" is-invalid" if form.outbound_client_secret.errors else ""),
                                              placeholder="Leave blank to keep current secret") }}
              <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                Leave blank to keep the existing secret unchanged.
              </p>
              {% for err in form.outbound_client_secret.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>

            {# Mailbox #}
            <div class="col-span-12 sm:col-span-6">
              <label for="{{ form.outbound_mailbox.id }}"
                     class="block text-sm font-semibold text-light-content-primary dark:text-content-primary mb-1">
                {{ form.outbound_mailbox.label.text }}
              </label>
              {{ form.outbound_mailbox(id=form.outbound_mailbox.id,
                                        class="mica-input" + (" is-invalid" if form.outbound_mailbox.errors else ""),
                                        placeholder="noreply@yourdomain.com") }}
              <p class="mt-1 text-xs text-light-content-muted dark:text-content-muted">
                The Exchange Online mailbox used as the sender (e.g. <code class="font-mono text-xs">noreply@</code>).
              </p>
              {% for err in form.outbound_mailbox.errors %}
                <p class="mt-1 text-xs text-status-danger">{{ err }}</p>
              {% endfor %}
            </div>
          </div>

          <div class="mt-5">
            {{ form.submit(class="btn-primary") }}
          </div>
        </div>{# /panel-outbound #}

      </form>

      {# Hidden purge form (outside main settings form) #}
      <form id="purge-form" method="post" action="{{ url_for('dmarc_reports.purge') }}" class="hidden">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      </form>
    </div>{# /mica-card #}
  </div>{# /col-span-7 #}

  {# -- Right column: context-sensitive sidebar -- #}
  <div class="col-span-12 lg:col-span-5 space-y-4">

    {# DNS sidebar (shown for DNS tab) #}
    <div id="sidebar-dns" class="settings-sidebar mica-card overflow-hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-info-circle mr-1.5"></i>DNS &amp; Monitoring Settings
        </span>
      </div>
      <div class="p-4 text-sm text-light-content-muted dark:text-content-muted">
        <dl class="space-y-3">
          <div>
            <dt class="font-semibold text-light-content-primary dark:text-content-primary">DNS Resolvers</dt>
            <dd>IP addresses of DNS servers used for all SPF, DMARC and DKIM lookups.
                Multiple servers are tried in order. Defaults: 8.8.8.8, 1.1.1.1, 9.9.9.9.</dd>
          </div>
          <div>
            <dt class="font-semibold text-light-content-primary dark:text-content-primary">Timeout</dt>
            <dd>Seconds to wait for a DNS response. Increase on slow or unreliable networks.</dd>
          </div>
          <div>
            <dt class="font-semibold text-light-content-primary dark:text-content-primary">Retries</dt>
            <dd>How many times to retry a failed DNS query before giving up.</dd>
          </div>
          <div>
            <dt class="font-semibold text-light-content-primary dark:text-content-primary">Flap Threshold</dt>
            <dd>Consecutive failures required before escalating to a critical alert.
                Setting to 1 disables anti-flapping protection.</dd>
          </div>
          <div>
            <dt class="font-semibold text-light-content-primary dark:text-content-primary">Display Timezone</dt>
            <dd>Controls how dates and times are shown. All data is stored in UTC; this only affects display.</dd>
          </div>
          <div>
            <dt class="font-semibold text-light-content-primary dark:text-content-primary">Check Concurrency</dt>
            <dd>Domains checked in parallel during "Check All". Higher values speed up batch checks
                but increase DNS load. Default: 5.</dd>
          </div>
          <div>
            <dt class="font-semibold text-light-content-primary dark:text-content-primary">Managed Domains</dt>
            <dd>Hostnames your organization manages. The dashboard shows
                <span class="badge-ok">YES</span> / <span class="badge-pending">NO</span> badges accordingly.</dd>
          </div>
          <div>
            <dt class="font-semibold text-light-content-primary dark:text-content-primary">RDAP Servers</dt>
            <dd>HTTPS endpoints for RDAP (RFC 9083) registrar lookups. Requests are
                distributed round-robin across all listed servers to avoid per-server
                rate limits. Falls back to WHOIS when RDAP fails.</dd>
          </div>
        </dl>
      </div>
    </div>

    {# Features sidebar (shown for Features tab) #}
    <div id="sidebar-features" class="settings-sidebar mica-card overflow-hidden hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-info-circle mr-1.5"></i>Feature Toggles
        </span>
      </div>
      <div class="p-4 text-sm text-light-content-muted dark:text-content-muted space-y-3">
        <div>
          <dt class="font-semibold text-light-content-primary dark:text-content-primary">Core checks</dt>
          <dd>SPF, DMARC, DKIM and MX are the primary email authentication checks. Their results
              determine the domain's <strong class="text-light-content-primary dark:text-content-primary">overall status</strong>
              (OK, Warning, Critical).</dd>
        </div>
        <div>
          <dt class="font-semibold text-light-content-primary dark:text-content-primary">Extended checks</dt>
          <dd>Reputation, Registrar, Geolocation, MTA-STS, BIMI and TLS are informational.
              They do <strong class="text-light-content-primary dark:text-content-primary">not</strong> affect the overall status
              but provide valuable context.</dd>
        </div>
        <div>
          <dt class="font-semibold text-light-content-primary dark:text-content-primary">Performance</dt>
          <dd>Disabling checks you don't need speeds up validation and reduces
              external API calls (WHOIS, GeoIP, SMTP connections).</dd>
        </div>
      </div>
    </div>

    {# Inbound sidebar (shown for Inbound tab) #}
    <div id="sidebar-inbound" class="settings-sidebar mica-card overflow-hidden hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-info-circle mr-1.5"></i>Graph API Setup Guide
        </span>
      </div>
      <div class="p-4 text-sm text-light-content-muted dark:text-content-muted space-y-3">
        <p>Follow these steps in the <strong class="text-light-content-primary dark:text-content-primary">Azure Portal</strong>
           to enable automatic DMARC report ingestion.</p>
        <ol class="list-decimal list-inside space-y-2 text-xs leading-relaxed">
          <li>Go to <strong class="text-light-content-primary dark:text-content-primary">Azure Active Directory → App registrations → New registration</strong>.</li>
          <li>Name the app (e.g. <em>DMARC Watcher</em>), leave defaults, click <strong class="text-light-content-primary dark:text-content-primary">Register</strong>.</li>
          <li>Copy the <strong class="text-light-content-primary dark:text-content-primary">Directory (tenant) ID</strong> and
              <strong class="text-light-content-primary dark:text-content-primary">Application (client) ID</strong> into the fields.</li>
          <li>Under <strong class="text-light-content-primary dark:text-content-primary">Certificates &amp; secrets → New client secret</strong> — copy the value immediately.</li>
          <li>Under <strong class="text-light-content-primary dark:text-content-primary">API permissions → Add a permission → Microsoft Graph → Application permissions</strong> — add
              <code class="font-mono bg-gray-100 dark:bg-surface-raised px-1 rounded">Mail.Read</code>, then
              <strong class="text-light-content-primary dark:text-content-primary">Grant admin consent</strong>.</li>
          <li>Enter the mailbox address that receives <code class="font-mono bg-gray-100 dark:bg-surface-raised px-1 rounded">rua=</code> reports.</li>
        </ol>
        <div class="pt-2 border-t border-light-surface-border/20 dark:border-surface-border/10">
          <p class="text-xs">
            <i class="bi bi-shield-check mr-1 text-status-ok"></i>
            The app uses <strong class="text-light-content-primary dark:text-content-primary">client credentials</strong> (no user sign-in).
            Unread emails with <code class="font-mono bg-gray-100 dark:bg-surface-raised px-1 rounded">.zip</code>,
            <code class="font-mono bg-gray-100 dark:bg-surface-raised px-1 rounded">.gz</code>, or
            <code class="font-mono bg-gray-100 dark:bg-surface-raised px-1 rounded">.xml</code> attachments are fetched
            and marked as read after ingestion.
          </p>
        </div>
        <div class="pt-2 border-t border-light-surface-border/20 dark:border-surface-border/10">
          <p class="text-xs">
            <i class="bi bi-clock-history mr-1 text-primary-400"></i>
            <strong class="text-light-content-primary dark:text-content-primary">Email collection</strong> is limited to
            the last <strong class="text-light-content-primary dark:text-content-primary">30 days</strong> to prevent excessive data download.
          </p>
          <p class="text-xs mt-1">
            <i class="bi bi-trash3 mr-1 text-status-danger"></i>
            <strong class="text-light-content-primary dark:text-content-primary">Data retention</strong> controls how long
            DMARC reports, check results, and change logs are kept. Use the purge button to clean up old data immediately.
          </p>
        </div>
      </div>
    </div>

    {# Outbound sidebar (shown for Outbound tab) #}
    <div id="sidebar-outbound" class="settings-sidebar mica-card overflow-hidden hidden">
      <div class="px-4 py-3 border-b border-light-surface-border/20 dark:border-surface-border/10">
        <span class="font-semibold text-sm text-light-content-primary dark:text-content-primary">
          <i class="bi bi-info-circle mr-1.5"></i>Outbound Email Setup Guide
        </span>
      </div>
      <div class="p-4 text-sm text-light-content-muted dark:text-content-muted space-y-3">
        <p>Configure outbound email for password resets and notifications via
           <strong class="text-light-content-primary dark:text-content-primary">Microsoft Graph API</strong>.</p>
        <ol class="list-decimal list-inside space-y-2 text-xs leading-relaxed">
          <li>Go to <strong class="text-light-content-primary dark:text-content-primary">Azure Active Directory → App registrations</strong>.</li>
          <li>Create a new app or reuse the inbound app if desired.</li>
          <li>Copy the <strong class="text-light-content-primary dark:text-content-primary">Tenant ID</strong> and
              <strong class="text-light-content-primary dark:text-content-primary">Client ID</strong>.</li>
          <li>Under <strong class="text-light-content-primary dark:text-content-primary">Certificates &amp; secrets</strong> — create a client secret.</li>
          <li>Under <strong class="text-light-content-primary dark:text-content-primary">API permissions</strong> — add
              <code class="font-mono bg-gray-100 dark:bg-surface-raised px-1 rounded">Mail.Send</code> (Application permission), then
              <strong class="text-light-content-primary dark:text-content-primary">Grant admin consent</strong>.</li>
          <li>Enter the sending mailbox address (e.g. <code class="font-mono bg-gray-100 dark:bg-surface-raised px-1 rounded">noreply@yourdomain.com</code>).</li>
        </ol>
        <div class="pt-2 border-t border-light-surface-border/20 dark:border-surface-border/10">
          <p class="text-xs">
            <i class="bi bi-shield-check mr-1 text-status-ok"></i>
            This can be the <strong class="text-light-content-primary dark:text-content-primary">same or a different</strong>
            Azure AD app from the inbound email configuration. Using separate apps provides better permission isolation.
          </p>
        </div>
      </div>
    </div>

    {# Last saved info #}
    {% if dns_settings and dns_settings.updated_at %}
    <div id="sidebar-lastsaved" class="mica-card overflow-hidden">
      <div class="p-4 text-sm text-light-content-muted dark:text-content-muted">
        <i class="bi bi-clock mr-1"></i>
        Last saved: {{ dns_settings.updated_at|to_tz }} {{ display_tz }}
        {% if dns_settings.updated_by_user %}
          by <strong class="text-light-content-primary dark:text-content-primary">{{ dns_settings.updated_by_user.username }}</strong>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </div>{# /col-span-5 #}
</div>{# /grid #}

{% endblock %}

{% block extra_js %}
<script>
(function () {
  var STORAGE_KEY = 'settings-active-tab';
  var INITIAL_TAB  = {{ _initial_tab | tojson }};

  /* Collect elements */
  var tabBtns   = document.querySelectorAll('.settings-tab-btn');
  var tabPanels = document.querySelectorAll('.settings-tab-panel');
  var sidebars  = document.querySelectorAll('.settings-sidebar');

  /* Active tab styling */
  var ACTIVE_BTN   = ['text-primary-500', 'dark:text-primary-400', 'border-primary-500', 'dark:border-primary-400'];
  var INACTIVE_BTN = ['text-light-content-secondary', 'dark:text-content-secondary',
                      'border-transparent', 'hover:border-gray-300',
                      'hover:text-light-content-primary', 'dark:hover:text-content-primary'];

  function activate(tabName) {
    /* Tab buttons */
    tabBtns.forEach(function (btn) {
      var isActive = btn.dataset.tab === tabName;
      ACTIVE_BTN.forEach(function (c)   { btn.classList.toggle(c,  isActive); });
      INACTIVE_BTN.forEach(function (c) { btn.classList.toggle(c, !isActive); });
    });

    /* Tab panels */
    tabPanels.forEach(function (panel) {
      panel.classList.toggle('hidden', panel.dataset.panel !== tabName);
    });

    /* Sidebars */
    sidebars.forEach(function (sb) {
      /* sidebar ids are "sidebar-<tabName>" */
      var match = sb.id === 'sidebar-' + tabName;
      sb.classList.toggle('hidden', !match);
    });

    sessionStorage.setItem(STORAGE_KEY, tabName);
  }

  /* Wire click handlers */
  tabBtns.forEach(function (btn) {
    btn.addEventListener('click', function () { activate(btn.dataset.tab); });
  });

  /* Restore saved tab, then apply server-side override (e.g. validation errors) */
  var saved = sessionStorage.getItem(STORAGE_KEY) || 'dns';
  activate(INITIAL_TAB !== 'dns' ? INITIAL_TAB : saved);

  /* Purge button confirmation */
  var purgeBtn = document.getElementById('btn-purge');
  if (purgeBtn) {
    purgeBtn.addEventListener('click', function () {
      var days = document.getElementById('data_retention_days');
      var val = days ? days.value : '90';
      if (confirm('Are you sure you want to permanently delete all DMARC reports, check results, and change logs older than ' + val + ' days?\n\nThis action cannot be undone.')) {
        document.getElementById('purge-form').submit();
      }
    });
  }
}());
</script>
{% endblock %}
